const oracledb = require("oracledb");
const db = require("../db/db");

oracledb.outFormat = oracledb.OUT_FORMAT_OBJECT;

exports.getFinancialReport = async (req, res) => {
  const { month } = req.query; // e.g., "2025-12"
  if (!month) return res.status(400).json({ error: "Month is required" });

  const startDate = `${month}-01`; // first day of the month
  const endDate = `${month}-31`;   // last day (simplified)

  let conn;
  try {
    conn = await oracledb.getConnection(db);

    // 1️⃣ Fetch all payments in that month with student & package info
    const paymentsResult = await conn.execute(
      `SELECT 
          s.STUDENT_NAME,
          p.PACKAGE_NAME,
          pay.Total_Fees,
          pay.Amount_Paid,
          (pay.Total_Fees - pay.Amount_Paid) AS Outstanding
       FROM PAYMENT pay
       JOIN ENROLLMENT e ON e.Payment_ID = pay.Payment_ID
       JOIN STUDENT s ON s.STUDENT_ID = e.Student_ID
       JOIN PACKAGE p ON p.Package_ID = e.Package_ID
       WHERE pay.Payment_Date BETWEEN TO_DATE(:startDate, 'YYYY-MM-DD') 
                                   AND TO_DATE(:endDate, 'YYYY-MM-DD')`,
      { startDate, endDate }
    );

    const payments = paymentsResult.rows;

    // 2️⃣ Calculate summary
    const totalRevenue = payments.reduce((sum, p) => sum + Number(p.TOTAL_FEES), 0);
    const totalCollected = payments.reduce((sum, p) => sum + Number(p.AMOUNT_PAID), 0);
    const outstandingFees = payments.reduce((sum, p) => sum + Number(p.OUTSTANDING), 0);
    const totalEnrollment = payments.length;

    res.json({
      summary: { totalRevenue, totalCollected, outstandingFees, totalEnrollment },
      payments
    });

  } catch (err) {
    console.error(err);
    res.status(500).json({ error: err.message });
  } finally {
    if (conn) await conn.close();
  }
};
