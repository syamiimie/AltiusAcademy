const oracledb = require("oracledb");
const db = require("../db/db"); // your DB config

oracledb.outFormat = oracledb.OUT_FORMAT_OBJECT;

exports.financialReport = async (req, res) => {
  const { month } = req.query; // expects "YYYY-MM"
  let conn;

  if (!month) {
    return res.status(400).json({ error: "Month is required" });
  }

  try {
    conn = await oracledb.getConnection(db);

    // 1️⃣ Fetch payment details per student
    const paymentsResult = await conn.execute(
      `
      SELECT 
          s.STUDENT_NAME,
          p.PACKAGE_NAME,
          p.PACKAGE_FEE AS TOTAL_FEE,
          NVL(r.total_paid,0) AS AMOUNT_PAID,
          p.PACKAGE_FEE - NVL(r.total_paid,0) AS OUTSTANDING
      FROM ENROLLMENT e
      JOIN STUDENT s ON e.STUDENT_ID = s.STUDENT_ID
      JOIN PACKAGE p ON e.PACKAGE_ID = p.PACKAGE_ID
      LEFT JOIN (
          SELECT PAYMENT_ID, SUM(RECEIPT_AMOUNT) AS total_paid
          FROM RECEIPT
          GROUP BY PAYMENT_ID
      ) r ON e.PAYMENT_ID = r.PAYMENT_ID
      WHERE TO_CHAR(e.ENROLL_DATE,'YYYY-MM') = :month
      ORDER BY s.STUDENT_NAME
      `,
      { month }
    );

    // 2️⃣ Compute summary totals
    const summaryResult = await conn.execute(
      `
      SELECT 
          SUM(p.PACKAGE_FEE) AS TOTAL_REVENUE,
          SUM(NVL(r.total_paid,0)) AS TOTAL_COLLECTED,
          SUM(p.PACKAGE_FEE - NVL(r.total_paid,0)) AS OUTSTANDING_FEES,
          COUNT(*) AS TOTAL_ENROLLMENT
      FROM ENROLLMENT e
      JOIN PACKAGE p ON e.PACKAGE_ID = p.PACKAGE_ID
      LEFT JOIN (
          SELECT PAYMENT_ID, SUM(RECEIPT_AMOUNT) AS total_paid
          FROM RECEIPT
          GROUP BY PAYMENT_ID
      ) r ON e.PAYMENT_ID = r.PAYMENT_ID
      WHERE TO_CHAR(e.ENROLL_DATE,'YYYY-MM') = :month
      `,
      { month }
    );

    res.json({
      summary: summaryResult.rows[0] || {
        TOTAL_REVENUE: 0,
        TOTAL_COLLECTED: 0,
        OUTSTANDING_FEES: 0,
        TOTAL_ENROLLMENT: 0
      },
      payments: paymentsResult.rows
    });

  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Failed to generate financial report" });
  } finally {
    if (conn) await conn.close();
  }
};
