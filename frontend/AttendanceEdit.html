<!DOCTYPE html>
<html>
<head>
  <title>Edit Attendance</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- HEADER -->
<header class="top-bar">
  <div class="logo">
    <a href="StaffHomepage.html">
      <img src="images/logo1.png" alt="Altius Academy">
    </a>
  </div>

  <nav class="nav-menu">
    <a href="TeacherList.html">Teacher</a>
    <a href="StudentList.html">Student</a>
    <a href="ClassList.html">Class</a>
    <a href="EnrollmentList.html">Enrollment</a>
    <a href="PackageList.html">Package</a>
    <a href="SubjectList.html">Subject</a>
    <a href="AttendanceList.html">Attendance</a>
    <a href="report.html">Report</a>
  </nav>

  <div class="user-icon" style="display:flex; gap:10px; align-items:center;">
    <button class="button" onclick="logout()">Logout</button>
    <span onclick="goStaffHome()" style="cursor:pointer;">ðŸ‘¤</span>
  </div>
</header>

<main class="content">
<form id="form">
<table class="form">
<tr><td colspan="2" class="titles">Edit Attendance</td></tr>

<tr>
  <td>Date</td>
  <td><input type="date" id="attend_date" required></td>
</tr>

<tr>
  <td>Status</td>
  <td>
    <select id="attend_status" required>
      <option value="Present">Present</option>
      <option value="Absent">Absent</option>
    </select>
  </td>
</tr>

<tr>
  <td>Class</td>
  <td>
    <select id="class_id" required>
      <option value="">-- Select Class --</option>
    </select>
  </td>
</tr>

<tr>
  <td>Student</td>
  <td>
    <select id="student_id" required>
      <option value="">-- Select Student --</option>
    </select>
  </td>
</tr>

<tr>
  <td colspan="2" align="center">
    <button class="button">Update</button>
  </td>
</tr>
</table>
</form>
</main>

<script>
const id = new URLSearchParams(location.search).get("id");
let selectedClass = null;
let selectedStudent = null;

// 1ï¸âƒ£ LOAD ATTENDANCE DATA
fetch(`http://localhost:3000/attendance/${id}`)
.then(r => r.json())
.then(a => {
  attend_date.value = a.ATTEND_DATE;
  attend_status.value = a.ATTEND_STATUS;
  selectedClass = a.CLASS_ID;
  selectedStudent = a.STUDENT_ID;

  loadClasses();
});

// 2ï¸âƒ£ LOAD CLASSES
function loadClasses(){
  fetch("http://localhost:3000/classes")
  .then(r => r.json())
  .then(classes => {
    class_id.innerHTML = `<option value="">-- Select Class --</option>`;
    classes.forEach(c => {
      class_id.innerHTML += `
        <option value="${c.CLASS_ID}">
          ${c.CLASS_ID} - ${c.CLASS_NAME}
        </option>
      `;
    });

    class_id.value = selectedClass;
    loadStudentsByClass(selectedClass);
  });
}

// 3ï¸âƒ£ LOAD STUDENTS BY CLASS
function loadStudentsByClass(classId){
  if(!classId) return;

  fetch(`http://localhost:3000/attendance/class/${classId}/students`)
  .then(r => r.json())
  .then(students => {
    student_id.innerHTML = `<option value="">-- Select Student --</option>`;
    students.forEach(s => {
      student_id.innerHTML += `
        <option value="${s.STUDENT_ID}">
          ${s.STUDENT_ID} - ${s.STUDENT_NAME}
        </option>
      `;
    });

    student_id.value = selectedStudent;
  });
}

// onchange class â†’ reload students
class_id.onchange = () => {
  loadStudentsByClass(class_id.value);
};

// 4ï¸âƒ£ SUBMIT UPDATE
form.onsubmit = e => {
  e.preventDefault();

  fetch(`http://localhost:3000/attendance/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      attend_date: attend_date.value,
      attend_status: attend_status.value,
      student_id: student_id.value,
      class_id: class_id.value
    })
  }).then(() => {
    alert("Attendance updated");
    location.href = "AttendanceList.html";
  });
};

function goStaffHome(){
  const staff = localStorage.getItem("staff");
  if(!staff){
    alert("Please login first");
    location.href = "login.html";
    return;
  }
  location.href = "StaffHomepage.html";
}
</script>

</body>
</html>
