<!DOCTYPE html>
<html lang="en">
<head>
    <title>Add New Class</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">

    <style>
        .search-results{
            position:absolute;
            background:#fff;
            border:1px solid #ccc;
            width:100%;
            max-height:150px;
            overflow-y:auto;
            z-index:10;
        }
        .search-results div{
            padding:6px;
            cursor:pointer;
        }
        .search-results div:hover{
            background:#eee;
        }
    </style>
</head>

<body>

<main class="content">
<form id="classForm">
<table class="form">

<tr><td colspan="2" class="titles">Add New Class</td></tr>

<tr>
    <td>Class ID:</td>
    <td><input id="Class_ID" required placeholder="C201"></td>
</tr>

<tr>
    <td>Name:</td>
    <td><input id="Class_Name" required></td>
</tr>

<tr>
    <td>Time:</td>
    <td><input id="Class_Time" required></td>
</tr>

<tr>
    <td>Day:</td>
    <td><input id="Class_Day" required></td>
</tr>

<tr>
    <td>Subject ID:</td>
    <td><input id="Class_Subjects" required></td>
</tr>

<tr>
    <td>Teacher ID:</td>
    <td><input id="Class_Teacher" required></td>
</tr>

<tr>
    <td>Prerequisite Class:</td>
    <td style="position:relative;">
        <input id="prereqSearch" placeholder="Search class code">
        <div id="searchResults" class="search-results"></div>
        <ul id="prereqList"></ul>
    </td>
</tr>

<tr>
    <td colspan="2" style="text-align:center;">
        <button class="button">Save</button>
    </td>
</tr>

</table>
</form>
</main>

<script>
const prereqClasses = [];
const searchInput = document.getElementById("prereqSearch");
const resultsBox = document.getElementById("searchResults");
const prereqList = document.getElementById("prereqList");

searchInput.addEventListener("input", () => {
    const q = searchInput.value.trim();
    resultsBox.innerHTML = "";
    if(!q) return;

    fetch(`http://localhost:3000/classes/search?q=${q}`)
        .then(r => r.json())
        .then(data => {
            data.forEach(c => {
                const div = document.createElement("div");
                div.textContent = `${c.class_id} - ${c.class_name}`;
                div.onclick = () => addPrereq(c.class_id);
                resultsBox.appendChild(div);
            });
        });
});

function addPrereq(id){
    if(prereqClasses.includes(id)) return;

    prereqClasses.push(id);
    const li = document.createElement("li");
    li.textContent = id + " ";

    const btn = document.createElement("button");
    btn.textContent = "âŒ";
    btn.onclick = () => {
        prereqClasses.splice(prereqClasses.indexOf(id),1);
        li.remove();
    };

    li.appendChild(btn);
    prereqList.appendChild(li);

    searchInput.value = "";
    resultsBox.innerHTML = "";
}

document.getElementById("classForm").onsubmit = e => {
    e.preventDefault();

    fetch("http://localhost:3000/classes",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
            id: Class_ID.value.trim(),
            name: Class_Name.value.trim(),
            time: Class_Time.value.trim(),
            day: Class_Day.value.trim(),
            subject_id: Class_Subjects.value.trim(),
            teacher_id: Class_Teacher.value.trim(),
            prerequisites: prereqClasses
        })
    }).then(()=>{
        alert("Class added");
        location.href="ClassList.html";
    });
};
</script>

</body>
</html>
