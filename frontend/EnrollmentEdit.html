<!DOCTYPE html>
<html lang="en">
<head>
    <title>Altius Academy | Edit Enrollment</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">

    <style>
        .preview-box {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 6px;
            background: #f9f9f9;
        }

        .danger {
            background-color: #d9534f;
            color: white;
        }
    </style>
</head>

<body>

<header class="top-bar">
    <div class="logo">
        <a href="StaffHomepage.html">
            <img src="images/logo1.png">
        </a>
    </div>

    <nav class="nav-menu">
        <a href="TeacherList.html">Teacher</a>
        <a href="StudentList.html">Student</a>
        <a href="ClassList.html">Class</a>
        <a href="EnrollmentList.html" class="active">Enrollment</a>
        <a href="PackageList.html">Package</a>
        <a href="SubjectList.html">Subject</a>
        <a href="AttendanceList.html">Attendance</a>
        <a href="report.html">Report</a>
    </nav>
</header>

<main class="content">
    <div><a href="EnrollmentList.html" class="button">Back</a></div><br>
    <h2>Edit Enrollment</h2> 
    <div id="enrollmentCards"></div>
</main>

<script>
const params = new URLSearchParams(window.location.search);
const studentId = params.get("studentId");
const container = document.getElementById("enrollmentCards");

let packages = [];
let subjects = [];

/* LOAD DATA */
Promise.all([
    fetch("http://localhost:3000/packages").then(r => r.json()),
    fetch("http://localhost:3000/subjects").then(r => r.json()),
    fetch("http://localhost:3000/enrollments").then(r => r.json())
]).then(([pack, subs, enrollments]) => {

    packages = pack;
    subjects = subs;

    const filtered = enrollments.filter(e => e.STUDENT_ID == studentId);

const uniqueEnrollments = {};
filtered.forEach(e => {
    if (!uniqueEnrollments[e.ENROLL_ID]) {
        uniqueEnrollments[e.ENROLL_ID] = e;
    }
});

Object.values(uniqueEnrollments).forEach(renderEnrollmentCard);

});

/* RENDER CARD */
function renderEnrollmentCard(e) {

    const subjectList = subjects
        .filter(s => s.PACKAGE_ID == e.PACKAGE_ID)
        .map(s => `<div>• ${s.SUBJECT_NAME}</div>`)
        .join("");

    container.innerHTML += `
        <form class="form" onsubmit="updateEnrollment(event, ${e.ENROLL_ID})">

            <h3>${e.STUDENT_NAME} — Enrollment #${e.ENROLL_ID}</h3>

            <label>Package</label>
            <select class="select-class" data-package onchange="onPackageChange(this)">
                ${packages.map(p =>
                    `<option value="${p.PACKAGE_ID}" ${p.PACKAGE_ID == e.PACKAGE_ID ? "selected" : ""}>
                        ${p.PACKAGE_NAME}
                    </option>`
                ).join("")}
            </select>

            <label>Subjects in Package</label>
            <div class="preview-box" data-subject-preview>
                ${subjectList || "<em>No subjects</em>"}
            </div>

            <label>Status</label>
            <select class="select-class" data-status>
                <option value="Active" ${e.ENROLL_STATUS === "Active" ? "selected" : ""}>Active</option>
                <option value="Inactive" ${e.ENROLL_STATUS === "Inactive" ? "selected" : ""}>Inactive</option>
                <option value="Completed" ${e.ENROLL_STATUS === "Completed" ? "selected" : ""}>Completed</option>
            </select>

            <div class="card-actions">
                <button class="button" type="submit">Update</button>
                <button type="button" class="button danger"
                    onclick="deleteEnrollment(${e.ENROLL_ID})">
                    Delete
                </button>
            </div>

        </form>
    `;
}

/* PACKAGE CHANGE → UPDATE PREVIEW */
function onPackageChange(select) {
    const form = select.closest("form");
    const preview = form.querySelector("[data-subject-preview]");

    preview.innerHTML = "";

    subjects
        .filter(s => s.PACKAGE_ID == select.value)
        .forEach(s => preview.innerHTML += `<div>• ${s.SUBJECT_NAME}</div>`);

    if (preview.innerHTML === "") {
        preview.innerHTML = "<em>No subjects</em>";
    }
}

/* UPDATE ENROLLMENT */
function updateEnrollment(event, enrollId) {
    event.preventDefault();

    const form = event.target;

    fetch(`http://localhost:3000/enrollments/${enrollId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            Package_ID: form.querySelector("[data-package]").value,
            Enroll_Status: form.querySelector("[data-status]").value
        })
    })
    .then(res => {
        if (!res.ok) throw new Error("Update failed");
        alert("Enrollment updated successfully");
    })
    .catch(err => alert(err.message));
}

/* DELETE ENROLLMENT */
function deleteEnrollment(enrollId) {
    if (!confirm("Are you sure you want to delete this enrollment?")) return;

    fetch(`http://localhost:3000/enrollments/${enrollId}`, {
        method: "DELETE"
    })
    .then(res => {
        if (!res.ok) throw new Error("Delete failed");
        alert("Enrollment deleted successfully");
        location.reload();
    })
    .catch(err => alert(err.message));
}
</script>

</body>
</html>
