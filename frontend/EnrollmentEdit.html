<!DOCTYPE html>
<html lang="en">
<head>
    <title>Altius Academy | Edit Enrollment</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">

    <style>
        .subject-card-container {
            display: grid;
            gap: 10px;
            margin-top: 8px;
        }

        .subject-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f9f9f9;
        }
    </style>
</head>

<body>

<header class="top-bar">
    <div class="logo">
        <a href="StaffHomepage.html">
            <img src="images/logo1.png">
        </a>
    </div>

    <nav class="nav-menu">
        <a href="TeacherList.html">Teacher</a>
        <a href="StudentList.html">Student</a>
        <a href="ClassList.html">Class</a>
        <a href="EnrollmentList.html" class="active">Enrollment</a>
        <a href="PackageList.html">Package</a>
        <a href="SubjectList.html">Subject</a>
        <a href="report.html">Report</a>
    </nav>
</header>

<main class="content">
    <h2 class="titles">Edit Student Enrollments</h2>
    <div id="enrollmentCards"></div>
</main>

<script>
const params = new URLSearchParams(window.location.search);
const studentId = params.get("studentId");

const container = document.getElementById("enrollmentCards");

let students = [];
let packages = [];
let subjects = [];

/* ===== LOAD DATA ===== */
Promise.all([
    fetch("http://localhost:3000/students").then(r => r.json()),
    fetch("http://localhost:3000/packages").then(r => r.json()),
    fetch("http://localhost:3000/subjects").then(r => r.json()),
    fetch("http://localhost:3000/enrollments").then(r => r.json())
]).then(([stu, pack, subs, enrollments]) => {

    students = stu;
    packages = pack;
    subjects = subs;

    const studentEnrollments = enrollments.filter(
        e => e.STUDENT_ID == studentId
    );

    if (studentEnrollments.length === 0) {
        container.innerHTML = "<p>No enrollments found.</p>";
        return;
    }

    /* ===== GROUP BY ENROLL_ID ===== */
    const grouped = {};

    studentEnrollments.forEach(row => {
        if (!grouped[row.ENROLL_ID]) {
            grouped[row.ENROLL_ID] = {
                ...row,
                subjects: []
            };
        }

        grouped[row.ENROLL_ID].subjects.push({
            SUBJECT_ID: row.SUBJECT_ID,
            SUBJECT_NAME: row.SUBJECT_NAME
        });
    });

    Object.values(grouped).forEach(e => renderEnrollmentCard(e));
});

/* ===== RENDER CARD ===== */
function renderEnrollmentCard(e) {

    const studentName =
        students.find(s => s.STUDENT_ID == e.STUDENT_ID)?.STUDENT_NAME || "-";

    const studentOptions = students.map(s =>
        `<option ${s.STUDENT_ID == e.STUDENT_ID ? "selected" : ""}>
            ${s.STUDENT_NAME}
        </option>`
    ).join("");

    const packageOptions = packages.map(p =>
        `<option value="${p.PACKAGE_ID}" ${p.PACKAGE_ID == e.PACKAGE_ID ? "selected" : ""}>
            ${p.PACKAGE_NAME}
        </option>`
    ).join("");

    container.innerHTML += `
        <form class="form" onsubmit="updateEnrollment(event, ${e.ENROLL_ID})">

            <h3>${studentName} â€” Enrollment #${e.ENROLL_ID}</h3>

            <label>Student</label>
            <select class="select-class" disabled>
                ${studentOptions}
            </select>

            <label>Package</label>
            <select class="select-class" data-package onchange="onPackageChange(this)">
                ${packageOptions}
            </select>

            <label>Subjects</label>
            <div class="subject-card-container">
                ${e.subjects.map(s => `
                    <div class="subject-card">
                        <strong>${s.SUBJECT_NAME}</strong>

                        <select class="select-class subject-select" disabled>
                            ${subjects
                                .filter(sub => sub.PACKAGE_ID == e.PACKAGE_ID)
                                .map(sub =>
                                    `<option value="${sub.SUBJECT_ID}"
                                        ${sub.SUBJECT_ID == s.SUBJECT_ID ? "selected" : ""}>
                                        ${sub.SUBJECT_NAME}
                                    </option>`
                                ).join("")
                            }
                        </select>
                    </div>
                `).join("")}
            </div>

            <label>Status</label>
            <select class="select-class" data-status>
                <option value="Active" ${e.ENROLL_STATUS === "Active" ? "selected" : ""}>Active</option>
                <option value="Inactive" ${e.ENROLL_STATUS === "Inactive" ? "selected" : ""}>Inactive</option>
                <option value="Completed" ${e.ENROLL_STATUS === "Completed" ? "selected" : ""}>Completed</option>
            </select>

            <div class="card-actions">
                <button class="button" type="submit">Update</button>
                <a href="EnrollmentList.html" class="button">Back</a>
            </div>

        </form>
    `;
}

/* ===== ENABLE SUBJECT EDITING ON PACKAGE CHANGE ===== */
function onPackageChange(packageSelect) {
    const form = packageSelect.closest("form");
    const subjectSelects = form.querySelectorAll(".subject-select");

    subjectSelects.forEach(select => {
        select.disabled = false;
        select.innerHTML = "";

        subjects
            .filter(s => s.PACKAGE_ID == packageSelect.value)
            .forEach(s => {
                select.innerHTML +=
                    `<option value="${s.SUBJECT_ID}">${s.SUBJECT_NAME}</option>`;
            });
    });
}

/* ===== UPDATE (NO SUBJECT_ID) ===== */
function updateEnrollment(event, enrollId) {
    event.preventDefault();

    const form = event.target;
    const packageId = form.querySelector("[data-package]").value;
    const status = form.querySelector("[data-status]").value;

    fetch(`http://localhost:3000/enrollments/${enrollId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            Package_ID: packageId,
            Enroll_Status: status
        })
    })
    .then(res => {
        if (!res.ok) throw new Error("Update failed");
        alert("Enrollment updated successfully");
    })
    .catch(err => alert(err.message));
}
</script>

</body>
</html>
