<!DOCTYPE html>
<html lang="en">
<head>
    <title>Altius Academy | Enrollment</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
</head>

<body>

<header class="top-bar">
    <div class="logo">
        <a href="StaffHomepage.html">
            <img src="images/logo1.png">
        </a>
    </div>

    <nav class="nav-menu">
        <a href="TeacherList.html">Teacher</a>
        <a href="StudentList.html">Student</a>
        <a href="ClassList.html">Class</a>
        <a href="EnrollmentList.html" class="active">Enrollment</a>
        <a href="PackageList.html">Package</a>
        <a href="SubjectList.html">Subject</a>
        <a href="report.html">Report</a>
    </nav>
</header>

<main class="content">

    <div class="section-header">
        <h2 class="page-title">Student Enrollments</h2>
        <a href="EnrollmentAdd.html" class="button add-button">Add</a>
    </div>

    <div class="enrollcard-container" id="enrollCards"></div>

</main>

<script>
fetch("http://localhost:3000/enrollments")
.then(res => res.json())
.then(data => {
    const container = document.getElementById("enrollCards");
    container.innerHTML = "";

    const grouped = {};

    data.forEach(e => {
        // Group by student
        const studentId = e.STUDENT_ID;

        if (!grouped[studentId]) {
            grouped[studentId] = {
                studentId: e.STUDENT_ID,
                studentName: e.STUDENT_NAME,
                statusSet: new Set(),
                packages: new Set(),
                classes: []
            };
        }

        // Collect all statuses, packages, and classes
        grouped[studentId].statusSet.add(e.ENROLL_STATUS);
        if (e.PACKAGE_NAME) grouped[studentId].packages.add(e.PACKAGE_NAME);

        grouped[studentId].classes.push({
            classId: e.CLASS_ID || "-",
            className: e.CLASS_NAME,
            time: e.CLASS_TIME,
            day: e.CLASS_DAY,
            subject: e.SUBJECT_NAME,
            teacher: e.TEACHER_NAME
        });
    });

    // Render each student card
    Object.values(grouped).forEach(student => {
        const packageText = [...student.packages].join(", ") || "N/A";
        const statusText = [...student.statusSet].join(", ");

        let rows = "";
        student.classes.forEach(c => {
            rows += `
                <tr>
                    <td>${c.classId}</td>
                    <td>${c.className}</td>
                    <td>${c.time}</td>
                    <td>${c.day}</td>
                    <td>${c.subject}</td>
                    <td>${c.teacher}</td>
                </tr>
            `;
        });

        container.innerHTML += `
            <div class="card">
                <div class="card-header">
                    <h3>${student.studentName}</h3>
                    <span class="badge active">${statusText}</span>
                </div>

                <p><b>Package:</b> ${packageText}</p>

                <h4>Class:</h4>

                <table class="class-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Class Name</th>
                            <th>Time</th>
                            <th>Day</th>
                            <th>Subject</th>
                            <th>Teacher</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>

                <div class="payment-title">
                    <a href="#" style="color: aquamarine;">Payment Details</a>
                </div>

                <div class="card-actions">
                    <button class="button" onclick="editEnrollment(${student.studentId})">
                        Edit
                    </button>

                    <button class="button" onclick="deleteEnrollment(${student.studentId})">
                        Delete
                    </button>
                </div>
            </div>
        `;
    });
});

function editEnrollment(studentId) {
    window.location.href = `EnrollmentEdit.html?studentId=${studentId}`;
}

function deleteEnrollment(studentId) {
    if (!confirm("Are you sure you want to delete ALL enrollments of this student?")) return;

    fetch(`http://localhost:3000/enrollments/student/${studentId}`, {
        method: "DELETE"
    })
    .then(res => {
        if (!res.ok) throw new Error("Delete failed");
        alert("Enrollments deleted successfully");
        location.reload();
    })
    .catch(err => alert(err.message));
}
</script>

</body>
</html>
